#@ load("@ytt:data", "data")
#@ load("@ytt:struct", "struct")
#@ load("common.lib.yml", "image_resource", "task_script")

#@ def _bump_eirinidotcf_dependencies(repo, repo_modified):
platform: linux
image_resource: #@ image_resource("eirini/ci")
inputs:
- name: #@ repo
outputs:
- name: #@ repo_modified
params:
  REPO: #@ repo
  REPO_MODIFIED: #@ repo_modified
run: #@ task_script("bump-yarn-packages.sh")
#@ end

#@ def _deploy_eirinidotcf():
platform: linux
image_resource: #@ image_resource("eirini/ci")
inputs:
- name: ci-resources
- name: eirinidotcf
- name: eirini-private-config
run: #@ task_script("deploy-eirinidotcf.sh")
#@ end

#@ def _deploy_jefe():
platform: linux
image_resource: #@ image_resource("eirini/ci")
inputs:
- name: eirini-private-config
params:
  JEFE_ADMIN_PASSWORD: #@ data.values.jefe.admin_password
  JEFE_DSN: #@ "{}:{}@tcp({}:{})".format(data.values.jefe.db.username, data.values.jefe.db.password, data.values.jefe.db.address, data.values.jefe.db.port)
  JEFE_GITHUB_CLIENT_ID: #@ data.values.jefe.github_oauth.client_id
  JEFE_GITHUB_SECRET: #@ data.values.jefe.github_oauth.client_secret
  JEFE_O_AUTH_ORG: #@ data.values.jefe.github_oauth.org
run: #@ task_script("deploy-jefe.sh")
#@ end

#@ def _deploy_pairup():
platform: linux
image_resource: #@ image_resource("eirini/ci")
inputs:
- name: ci-resources
- name: pairup
- name: eirini-private-config
run: #@ task_script("deploy-pairup.sh")
params:
  FIREBASE_CONF: #@ data.values.pairup.firebase_conf
#@ end

#@ def _deploy_postfacto():
platform: linux
image_resource: #@ image_resource("eirini/ci")
inputs:
- name: postfacto
- name: eirini-private-config
- name: ci-resources
- name: redis-password
params:
  MYSQL_ADDRESS: #@ data.values.postfacto.mysql.address
  MYSQL_PASSWORD: #@ data.values.postfacto.mysql.password
run: #@ task_script("deploy-postfacto-cf4k8s.sh")
#@ end

#@ def _get_redis_credentials():
platform: linux
image_resource: #@ image_resource("eirini/gcloud")
inputs:
- name: kube
outputs:
- name: redis-password
run: #@ task_script("get-postfacto-credentials-cf4k8s.sh")
#@ end

#@ def _helm_install_redis():
platform: linux
image_resource: #@ image_resource("eirini/gcloud")
inputs:
- name: kube
run: #@ task_script("helm-install-redis.sh")
params:
  GCP_REGION: #@ data.values.gcp.region
  GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
  GCP_ZONE: #@ data.values.gcp.zone
  KUBECONFIG: kube/config
#@ end

#@ def _unclaim_clusters():
platform: linux
image_resource: #@ image_resource("eirini/ci")
params:
  JEFE_ADMIN_PASSWORD: #@ data.values.jefe.admin_password
  JEFE_URL: #@ data.values.jefe.url
run: #@ task_script("unclaim-clusters.sh")
#@ end

#@ egg = struct.make(
#@   bump_eirinidotcf_dependencies=_bump_eirinidotcf_dependencies,
#@   deploy_eirinidotcf=_deploy_eirinidotcf,
#@   deploy_jefe=_deploy_jefe,
#@   deploy_pairup=_deploy_pairup,
#@   deploy_postfacto=_deploy_postfacto,
#@   get_redis_credentials=_get_redis_credentials,
#@   helm_install_redis=_helm_install_redis,
#@   unclaim_clusters=_unclaim_clusters,
#@ )
