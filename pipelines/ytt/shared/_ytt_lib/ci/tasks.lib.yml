#@ load("@ytt:data", "data")
#@ load("@ytt:template", "template")

#@ def run_shellcheck(input_name="eirini"):
task: run-shellcheck
config:
  platform: linux
  image_resource: #@ image_resource("koalaman/shellcheck-alpine", "stable")
  inputs:
  - name: ci-resources
  run:
    path: /usr/bin/env
    args:
    - sh
    - -c
    - #@ data.read("tasks/check-shell.sh")
#@ end

#@ def run_shfmt():
task: run-shfmt
config:
  platform: linux
  inputs:
  - name: ci-resources
  image_resource: #@ image_resource("eirini/ci")
  run: #@ task_script("format-shell.sh")
#@ end

#@ def check_wip_branches():
task: check-wip-branches
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  run: #@ task_script("check-wip-branches.sh")
#@ end

#@ def check_golangci_linters():
task: check-wip-branches
config:
  platform: linux
  inputs:
  - name: eirini
  image_resource: #@ image_resource("eirini/golangci-lint")
  run: #@ task_script("check-golangci-linters.sh")
#@ end


#@ def run_unit_tests(input_name="eirini"):
task: run-unit-tests
input_mapping:
  eirini: #@ input_name
config:
  _: #@ template.replace(config())
  inputs:
  - name: eirini
  image_resource: #@ image_resource("eirini/ci")
  run: #@ task_script("run-unit-tests.sh")
#@ end

#@ def run_static_checks(input_name="eirini"):
task: run-static-checks
input_mapping:
  eirini: #@ input_name
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("golangci/golangci-lint")
  inputs:
  - name: eirini
  run: #@ task_script("run-static-checks.sh")
#@ end

#@ def download_kubeconfig(cluster_name):
task: download-kubeconfig
config:
  platform: linux
  image_resource: #@ image_resource("google/cloud-sdk")
  inputs:
  - name: ci-resources
  outputs:
  - name: kube
  run: #@ task_script("gcp-download-kubeconfig.sh")
params:
  CLUSTER_NAME: #@ cluster_name
  GCP_REGION: #@ data.values.gcp.region
  GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
  GCP_ZONE: #@ data.values.gcp.zone
#@ end

#@ def apply_eirini_crds():
task: apply-eirini-crds
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: eirini-release
  - name: kube
  params:
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
    KUBECONFIG: kube/config
  run: #@ task_script("apply-eirini-crds.sh")
#@ end

#@ def run_integration_tests():
task: run-integration-tests
privileged: true
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("eirini/telepresence")
  inputs:
  - name: eirini
  - name: kube
  outputs:
  - name: output
  params:
    EIRINIUSER_PASSWORD: #@ data.values.dockerhub.password
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
  run: #@ task_script("run-integration-tests.sh")
#@ end

#@ def run_eats_tests():
task: run-eats-tests
privileged: true
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("eirini/telepresence")
  inputs:
  - name: eirini
  - name: kube
  outputs:
  - name: output
  params:
    EIRINIUSER_PASSWORD: #@ data.values.dockerhub.password
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
    KUBECONFIG: kube/config
  run: #@ task_script("run-eats-tests.sh")
#@ end

#@ def update_version_files(components):
task: update-version-files
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: eirini
  - name: eirini-release
  #@ for component in components:
  - name: #@ component + "-image"
  #@ end
  outputs:
  - name: eirini-release-updated
  params:
    COMPONENT_NAME: eirini
    COMPONENT_REPO: eirini
    IMAGES: #@ " ".join(components)
  run: #@ task_script("update-version-files.sh")
#@ end

#@ def cleanup_deployment():
task: cleanup-deployment
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: eirini-release
  - name: kube
  params:
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
    KUBECONFIG: kube/config
  run:
    path: eirini-release/scripts/cleanup.sh
#@ end

#@ def deploy_eirini_yamls():
task: deploy-eirini-yamls
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: eirini-release
  - name: kube
  params:
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
    KUBECONFIG: kube/config
    WIREMOCK_KEYSTORE_PASSWORD: #@ data.values.wiremock_keystore_pass
  run:
    path: eirini-release/scripts/deploy.sh
#@ end

#@ def run_rubocop():
task: run-rubocop
config:
  platform: linux
  image_resource: #@ image_resource("eirini/capi-tests")
  inputs:
  - name: cloud_controller_ng
  run: #@ task_script("cloud-controller-rubocop.sh")
#@ end

#@ def run_cc_tests():
task: run-cc-tests
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("eirini/capi-tests")
  inputs:
  - name: cloud_controller_ng
  - name: kube
  outputs:
  - name: output
  params:
    GOOGLE_APPLICATION_CREDENTIALS: kube/service-account.json
  run: #@ task_script("cloud-controller-tests.sh")
#@ end

#@ def bump_go_modules(input_name):
task: bump-go-modules
input_mapping:
  repository: #@ input_name
config:
  _: #@ template.replace(config())
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: repository
  - name: golang-image
  outputs:
  - name: repository-updated
  run: #@ task_script("bump-go-packages.sh")
#@ end

#@ def delete_kubernetes_cluster(cluster_name):
task: delete-kubernetes-cluster
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: ci-resources
  params:
    CLUSTER_NAME: #@ cluster_name
    GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
    WORKER_COUNT: #@ data.values.gcp.worker_count
  run: #@ task_script("gcp-delete-cluster.sh")
#@ end

#@ def delete_values_file(cluster_name):
task: delete-values-file
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: cluster-state
  outputs:
  - name: state-modified
  params:
    CLUSTER_NAME: #@ cluster_name
  run: #@ task_script("clean-up-cluster-config.sh")
#@ end

#@ def delete_disks(cluster_name):
task: delete-disks
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: ci-resources
  params:
    CLUSTER_NAME: #@ cluster_name
    GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
  run: #@ task_script("delete-unused-gcp-disks.sh")
#@ end

#@ def create_kubernetes_cluster(cluster_name):
task: create-kubernetes-cluster
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: ci-resources
  params:
    CLUSTER_NAME: #@ cluster_name
    GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
    WINDOWS_POOL: "false"
    WORKER_COUNT: #@ data.values.gcp.worker_count
  run: #@ task_script("gcp-create-cluster.sh")
#@ end

#@ def build_docker_image(component):
task: #@ "build-" + component
privileged: true
output_mapping:
  image: #@ component + "-image"
config:
  platform: linux
  caches:
  - path: cache
  image_resource: #@ image_resource("vito/oci-build-task")
  inputs:
  - name: eirini
  outputs:
  - name: image
  params:
    CONTEXT: eirini
    DOCKERFILE: #@ "eirini/docker/" + component + "/Dockerfile"
  run:
    path: /bin/sh
    args:
      - -c
      - -e
      - |
        BUILD_ARG_GIT_SHA=$(cat eirini/.git/ref)
        export BUILD_ARG_GIT_SHA
        build
#@ end

#@ def helm_install_redis():
task: helm-install-redis
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: kube
  run: #@ task_script("helm-install-redis.sh")
params:
  GCP_REGION: #@ data.values.gcp.region
  GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
  GCP_ZONE: #@ data.values.gcp.zone
  KUBECONFIG: kube/config
#@ end

#@ def get_redis_credentials():
task: get-credentials
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: kube
  outputs:
  - name: redis-password
  run: #@ task_script("get-postfacto-credentials-cf4k8s.sh")
#@ end

#@ def deploy_postfacto():
task: deploy
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: postfacto
  - name: eirini-private-config
  - name: ci-resources
  - name: redis-password
  params:
    MYSQL_ADDRESS: #@ data.values.postfacto.mysql.address
    MYSQL_PASSWORD: #@ data.values.postfacto.mysql.password
  run: #@ task_script("deploy-postfacto-cf4k8s.sh")
#@ end

#@ def deploy_jefe():
task: deploy
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: eirini-private-config
  params:
    JEFE_ADMIN_PASSWORD: #@ data.values.jefe.admin_password
    JEFE_DSN: #@ "{}:{}@tcp({}:{})".format(data.values.jefe.db.username, data.values.jefe.db.password, data.values.jefe.db.address, data.values.jefe.db.port)
    JEFE_GITHUB_CLIENT_ID: #@ data.values.jefe.github_oauth.client_id
    JEFE_GITHUB_SECRET: #@ data.values.jefe.github_oauth.client_secret
    JEFE_O_AUTH_ORG: #@ data.values.jefe.github_oauth.org
  run: #@ task_script("deploy-jefe.sh")
#@ end

#@ def deploy_eirinidotcf():
task: deploy-web
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: ci-resources
  - name: eirinidotcf
  - name: eirini-private-config
  run: #@ task_script("deploy-eirinidotcf.sh")
#@ end

#@ def unclaim_clusters():
task: unclaim
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  params:
    JEFE_ADMIN_PASSWORD: #@ data.values.jefe.admin_password
    JEFE_URL: #@ data.values.jefe.url
  run: #@ task_script("unclaim-clusters.sh")
#@ end

#@ def bump_eirinidotcf_dependencies():
task: bump-eirinidotcf-dependencies
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: eirinidotcf
  outputs:
  - name: eirinidotcf-updated
  run: #@ task_script("bump-yarn-packages.sh")
#@ end

#@ def deploy_pairup():
task: deploy-web
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: ci-resources
  - name: pairup
  - name: eirini-private-config
  run: #@ task_script("deploy-pairup.sh")
params:
  FIREBASE_CONF: #@ data.values.pairup.firebase_conf
#@ end

#@ def create_release():
task: create-release
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: ci-resources
  - name: state
  - name: eirini-release
  - name: eirini-release-version
  outputs:
  - name: release-output
  - name: release-output-yaml
  run: #@ task_script("create-release.sh")
#@ end

#@ def checkout_eirini_sha():
task: checkout-eirini-sha
privileged: true
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: eirini-release
  - name: eirini
  - name: ci-resources
  outputs:
  - name: eirini-stable
  run: #@ task_script("checkout-sha-by-image.sh")
#@ end

#@ def generate_default_values(cluster_name):
task: generate-default-values
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: cf-for-k8s
  - name: kube
  outputs:
  - name: default-values-file
  run: #@ task_script("generate-default-cf4k8s-values.sh")
params:
  CLUSTER_NAME: #@ cluster_name
  GCP_SERVICE_ACCOUNT: #@ data.values.gcp.service_account_json
#@ end

#@ def generate_loadbalancer_values(cluster_name):
task: generate-loadbalancer-values
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: ci-resources
  outputs:
  - name: loadbalancer-values-file
  run: #@ task_script("generate-loadbalancer-cf4k8s-values.sh")
params:
  CLUSTER_NAME: #@ cluster_name
  GCP_REGION: #@ data.values.gcp.region
  GCP_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.service_account_json
  GCP_ZONE: #@ data.values.gcp.zone
#@ end

#@ def aggregate_cf4k8s_values(cluster_name):
task: aggregate-cf4k8s-values
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: cluster-state
  - name: default-values-file
  - name: loadbalancer-values-file
  outputs:
  - name: state-modified
  run: #@ task_script("aggregate-cf4k8s-values.sh")
params:
  CLUSTER_NAME: #@ cluster_name
#@ end

#@ def delete_cf():
task: delete-cf
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: kube
  run: #@ task_script("delete-cf-for-k8s.sh")
#@ end

#@ def patch_eirini_release():
task: patch-eirini-release
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: cf-for-k8s
  - name: eirini-release
  outputs:
  - name: patched-cf-for-k8s
  run: #@ task_script("patch-eirini-release-cf-for-k8s.sh")
#@ end

#@ def deploy_cf_for_k8s(cluster_name):
task: deploy-cf-for-k8s
config:
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: patched-cf-for-k8s
  - name: cf-k8s-prometheus
  - name: cluster-state
  - name: ci-resources
  - name: kube
  params:
    CLUSTER_NAME: #@ cluster_name
    USE_CERT_MANAGER: #@ data.values.use_cert_manager
  platform: linux
  run: #@ task_script("deploy-cf-for-k8s.sh")
#@ end

#@ def get_smoke_test_variables(cluster_name):
task: get-smoke-tests-variables
config:
  platform: linux
  image_resource: #@ image_resource("eirini/ci")
  inputs:
  - name: cluster-state
  outputs:
  - name: smoke-tests-env-vars
  params:
    CLUSTER_NAME: #@ cluster_name
  run: #@ task_script("get-smoke-tests-variables.sh")
#@ end

#@ def run_smoke_tests():
task: run-smoke-tests
config:
  platform: linux
  image_resource: #@ image_resource("cloudfoundry/cf-for-k8s-ci")
  inputs:
  - name: cf-for-k8s
  - name: smoke-tests-env-vars
  params:
    SMOKE_TEST_SKIP_SSL: "true"
    SMOKE_TEST_USERNAME: admin
  run: #@ task_script("run-smoke-tests.sh")
#@ end

#@ def generate_domain_certificates():
task: generate-domain-certificates
config:
  platform: linux
  image_resource: #@ image_resource("eirini/gcloud")
  inputs:
  - name: kube
  - name: ci-resources
  params:
    DNS_SERVICE_ACCOUNT_JSON: #@ data.values.gcp.dns_service_account_json
    GCP_PROJECT_ID: #@ data.values.gcp.project_id
  run: #@ task_script("install-cert-manager.sh")
#@ end

#@ def config():
platform: linux
caches:
- path: /root/.cache/go-build
#@ end

#@ def image_resource(repository, tag="latest"):
type: registry-image
source:
  repository: #@ repository
  tag: #@ tag
  username: #@ data.values.dockerhub.username
  password: #@ data.values.dockerhub.password
#@ end

#@ def task_script(filename):
path: /bin/bash
args:
- -c
- #@ data.read("tasks/" + filename)
#@ end

